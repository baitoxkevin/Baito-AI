<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Gemini OCR (with PDF Support)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 3rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #667eea;
      margin-bottom: 0.5rem;
      font-size: 2rem;
    }

    .subtitle {
      color: #666;
      margin-bottom: 2rem;
      font-size: 0.9rem;
    }

    .badge {
      display: inline-block;
      background: #4CAF50;
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .api-key-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      border-left: 4px solid #667eea;
    }

    .api-key-section label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #333;
    }

    .api-key-section input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: border-color 0.3s;
    }

    .api-key-section input:focus {
      outline: none;
      border-color: #667eea;
    }

    .api-key-section small {
      display: block;
      margin-top: 0.5rem;
      color: #666;
    }

    .api-key-section small a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }

    .upload-zone {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 3rem;
      text-align: center;
      background: #f8f9ff;
      transition: all 0.3s;
      cursor: pointer;
      margin-bottom: 2rem;
    }

    .upload-zone:hover {
      background: #f0f2ff;
      border-color: #5568d3;
    }

    .upload-zone.dragover {
      background: #e8ebff;
      border-color: #4a56b5;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .upload-text {
      font-size: 1.2rem;
      color: #667eea;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .upload-subtext {
      color: #999;
      font-size: 0.9rem;
    }

    input[type="file"] {
      display: none;
    }

    .preview-section {
      display: none;
      margin-bottom: 2rem;
    }

    .preview-section.active {
      display: block;
    }

    .preview-image {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 10px;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .file-info {
      background: #f0f2ff;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #667eea;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      display: none;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .results {
      display: none;
      background: #f8f9fa;
      padding: 2rem;
      border-radius: 15px;
      margin-top: 2rem;
    }

    .results.active {
      display: block;
    }

    .results h2 {
      color: #667eea;
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
    }

    .result-item {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border-left: 4px solid #667eea;
    }

    .result-label {
      font-weight: 600;
      color: #666;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
    }

    .result-value {
      font-size: 1.1rem;
      color: #333;
    }

    .result-value.amount {
      font-size: 1.5rem;
      font-weight: 700;
      color: #667eea;
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      border-left: 4px solid #c33;
      display: none;
    }

    .error.active {
      display: block;
    }

    .success {
      background: #efe;
      color: #3c3;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      border-left: 4px solid #3c3;
      display: none;
    }

    .success.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="badge">‚ú® PDF Support Enabled</div>
    <h1>üßæ Test Gemini OCR</h1>
    <p class="subtitle">Upload a receipt image or PDF to test Google Gemini Vision API</p>

    <!-- API Key Input -->
    <div class="api-key-section">
      <label for="apiKey">Gemini API Key:</label>
      <input
        type="password"
        id="apiKey"
        placeholder="AIzaSy..."
        autocomplete="off"
      />
      <small>Get your free API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
    </div>

    <!-- Upload Zone -->
    <div class="upload-zone" id="uploadZone">
      <div class="upload-icon">üì∏</div>
      <div class="upload-text">Drop receipt (image or PDF) here or click to upload</div>
      <div class="upload-subtext">Supports JPEG, PNG, WebP, PDF ‚Ä¢ Max 5MB</div>
      <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png,image/webp,application/pdf" />
    </div>

    <!-- Preview Section -->
    <div class="preview-section" id="previewSection">
      <div class="file-info" id="fileInfo"></div>
      <img id="previewImage" class="preview-image" alt="Receipt preview" />
      <button class="btn" id="analyzeBtn">üîç Analyze Receipt</button>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p id="loadingText">Analyzing receipt with Gemini AI...</p>
    </div>

    <!-- Results -->
    <div class="results" id="results">
      <h2>‚úÖ Extracted Data</h2>
      <div class="result-item">
        <div class="result-label">Vendor</div>
        <div class="result-value" id="resultVendor">-</div>
      </div>
      <div class="result-item">
        <div class="result-label">Amount</div>
        <div class="result-value amount" id="resultAmount">-</div>
      </div>
      <div class="result-item">
        <div class="result-label">Date</div>
        <div class="result-value" id="resultDate">-</div>
      </div>
      <div class="result-item">
        <div class="result-label">Category</div>
        <div class="result-value" id="resultCategory">-</div>
      </div>
      <div class="result-item">
        <div class="result-label">Description</div>
        <div class="result-value" id="resultDescription">-</div>
      </div>
      <div class="result-item">
        <div class="result-label">Items</div>
        <div class="result-value" id="resultItems">-</div>
      </div>
    </div>

    <!-- Messages -->
    <div class="error" id="error"></div>
    <div class="success" id="success"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script type="module">
    import { GoogleGenerativeAI } from 'https://esm.run/@google/generative-ai';

    // Set PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const previewSection = document.getElementById('previewSection');
    const previewImage = document.getElementById('previewImage');
    const fileInfo = document.getElementById('fileInfo');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loadingText');
    const results = document.getElementById('results');
    const error = document.getElementById('error');
    const success = document.getElementById('success');
    const apiKeyInput = document.getElementById('apiKey');

    let selectedFile = null;
    let imageDataUrl = null;

    // Upload zone click
    uploadZone.addEventListener('click', () => fileInput.click());

    // Drag and drop
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });

    // Handle file selection
    async function handleFile(file) {
      // Validate file type
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'application/pdf'];
      if (!validTypes.includes(file.type)) {
        showError('Invalid file type. Please upload JPEG, PNG, WebP, or PDF.');
        return;
      }

      // Validate file size (5MB)
      if (file.size > 5 * 1024 * 1024) {
        showError('File too large. Maximum size is 5MB.');
        return;
      }

      selectedFile = file;
      hideMessages();

      // Show file info
      const fileSize = (file.size / 1024).toFixed(1);
      const fileType = file.type.includes('pdf') ? 'üìÑ PDF' : 'üñºÔ∏è Image';
      fileInfo.textContent = `${fileType} ‚Ä¢ ${file.name} ‚Ä¢ ${fileSize} KB`;

      if (file.type === 'application/pdf') {
        // Convert PDF to image
        loadingText.textContent = 'Converting PDF to image...';
        loading.classList.add('active');

        try {
          imageDataUrl = await pdfToImage(file);
          previewImage.src = imageDataUrl;
          previewSection.classList.add('active');
          loading.classList.remove('active');
        } catch (err) {
          loading.classList.remove('active');
          showError('Failed to process PDF: ' + err.message);
        }
      } else {
        // Show image preview
        const reader = new FileReader();
        reader.onload = (e) => {
          imageDataUrl = e.target.result;
          previewImage.src = imageDataUrl;
          previewSection.classList.add('active');
        };
        reader.readAsDataURL(file);
      }
    }

    // Convert PDF first page to image
    async function pdfToImage(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      // Get first page
      const page = await pdf.getPage(1);

      // Set scale for good quality
      const viewport = page.getViewport({ scale: 2.0 });

      // Create canvas
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      // Render PDF page to canvas
      await page.render({
        canvasContext: context,
        viewport: viewport
      }).promise;

      // Convert canvas to data URL
      return canvas.toDataURL('image/jpeg', 0.95);
    }

    // Analyze button click
    analyzeBtn.addEventListener('click', async () => {
      if (!selectedFile || !imageDataUrl) return;

      // Validate API key
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        showError('Please enter your Gemini API key');
        apiKeyInput.focus();
        return;
      }

      hideMessages();
      loadingText.textContent = 'Analyzing receipt with Gemini AI...';
      loading.classList.add('active');
      results.classList.remove('active');

      try {
        const result = await analyzeReceipt(imageDataUrl, apiKey);

        if (result.success && result.data) {
          displayResults(result.data);
          showSuccess('Receipt analyzed successfully!');
        } else {
          showError(result.error || 'Failed to analyze receipt');
        }
      } catch (err) {
        showError(err.message || 'An error occurred');
      } finally {
        loading.classList.remove('active');
      }
    });

    // Analyze receipt function
    async function analyzeReceipt(dataUrl, apiKey) {
      try {
        const genAI = new GoogleGenerativeAI(apiKey);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-lite" });

        // Extract base64 from data URL
        const base64 = dataUrl.split(',')[1];
        const mimeType = dataUrl.split(':')[1].split(';')[0];

        const prompt = `Extract the following information from this receipt and return ONLY a valid JSON object (no markdown, no explanations):

{
  "vendor": "store or vendor name",
  "amount": total_amount_as_number,
  "date": "YYYY-MM-DD",
  "description": "brief description",
  "items": ["item1", "item2"],
  "category": "one of: transport, meals, accommodation, supplies, equipment, communication, training, other"
}

Important:
- Extract TOTAL amount (not subtotal)
- Date must be YYYY-MM-DD format
- Return ONLY valid JSON`;

        const result = await model.generateContent([
          prompt,
          {
            inlineData: {
              data: base64,
              mimeType: mimeType
            }
          }
        ]);

        const text = result.response.text();
        console.log('Raw response:', text);

        // Parse JSON
        const cleanText = text
          .replace(/```json\n?/g, '')
          .replace(/```\n?/g, '')
          .trim();

        const parsed = JSON.parse(cleanText);

        return {
          success: true,
          data: {
            vendor: parsed.vendor || 'Unknown',
            amount: parseFloat(parsed.amount) || 0,
            date: parsed.date || new Date().toISOString().split('T')[0],
            description: parsed.description || '',
            category: parsed.category || 'other',
            items: parsed.items || []
          }
        };
      } catch (err) {
        console.error('Analysis error:', err);
        return {
          success: false,
          error: err.message
        };
      }
    }

    // Display results
    function displayResults(data) {
      document.getElementById('resultVendor').textContent = data.vendor;
      document.getElementById('resultAmount').textContent = `RM ${data.amount.toFixed(2)}`;
      document.getElementById('resultDate').textContent = data.date;
      document.getElementById('resultCategory').textContent = data.category;
      document.getElementById('resultDescription').textContent = data.description || 'N/A';
      document.getElementById('resultItems').textContent = data.items.length > 0
        ? data.items.join(', ')
        : 'N/A';

      results.classList.add('active');
    }

    // Show error
    function showError(message) {
      error.textContent = message;
      error.classList.add('active');
      setTimeout(() => error.classList.remove('active'), 5000);
    }

    // Show success
    function showSuccess(message) {
      success.textContent = message;
      success.classList.add('active');
      setTimeout(() => success.classList.remove('active'), 3000);
    }

    // Hide messages
    function hideMessages() {
      error.classList.remove('active');
      success.classList.remove('active');
    }
  </script>
</body>
</html>
